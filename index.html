<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Ronda de Extintores</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #333; }
    button { margin: 5px; padding: 10px; border-radius: 6px; cursor: pointer; border: none; }
    .vistoriado { background: #28a745; color: #fff; }
    .nao-vistoriado { background: #f0f0f0; color: #000; }
    #mensagem { margin:10px; padding:8px; display:none; border-radius:4px; font-weight:bold; }
  </style>
</head>
<body>
  <h1>Ronda de Extintores</h1>

  <label for="nomeUsuario">👨‍🚒 Seu Nome:</label>
  <input type="text" id="nomeUsuario" placeholder="Digite seu nome">

  <br><br>

  <label for="edificacao">🏢 Escolha a edificação:</label>
  <select id="edificacao"></select>

  <div id="extintores" style="margin-top:20px;"></div>

  <div id="mensagem"></div>

  <br>
  <button onclick="resetarTodos()">🔄 Resetar TODOS os extintores</button>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // 🔹 SUA CONFIG FIREBASE AQUI
    const firebaseConfig = {
      apiKey: "AIzaSyC7lypBBMv9RJ7ta3uaXTiU4txg8x91TWI",
      authDomain: "ronda-extintores.firebaseapp.com",
      projectId: "ronda-extintores",
      storageBucket: "ronda-extintores.firebasestorage.app",
      messagingSenderId: "712050420595",
      appId: "1:712050420595:web:96ce82f25307c7aba4f306",
      measurementId: "G-S8SERMVVCR",
      databaseURL: "https://ronda-extintores-default-rtdb.firebaseio.com/"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 🔹 Sistema de mensagens
    function mostrarMensagem(texto, tipo="info") {
      const msg = document.getElementById("mensagem");
      msg.innerText = texto;

      if (tipo === "sucesso") {
        msg.style.background = "#d4edda";
        msg.style.color = "#155724";
        msg.style.border = "1px solid #c3e6cb";
      } else if (tipo === "erro") {
        msg.style.background = "#f8d7da";
        msg.style.color = "#721c24";
        msg.style.border = "1px solid #f5c6cb";
      } else {
        msg.style.background = "#cce5ff";
        msg.style.color = "#004085";
        msg.style.border = "1px solid #b8daff";
      }

      msg.style.display = "block";
      setTimeout(() => { msg.style.display = "none"; }, 5000);
    }

    // 🔹 Marcar extintor com nome obrigatório
    function toggleExtintor(edificacao, numero) {
      const nomeUsuario = document.getElementById("nomeUsuario").value.trim();

      if (!nomeUsuario) {
        mostrarMensagem("⚠️ Digite seu nome antes de marcar a vistoria!", "erro");
        return;
      }

      const ref = db.ref(`extintores/${edificacao}/${numero}`);
      ref.once("value").then(snapshot => {
        const atual = snapshot.val() || {};
        const novoStatus = !atual.vistoriado;
        ref.update({
          vistoriado: novoStatus,
          por: novoStatus ? nomeUsuario : ""
        });
      });
    }

    // 🔹 Renderizar extintores (mostra quem marcou)
    function renderizarExtintores(edificacao) {
      const container = document.getElementById("extintores");
      container.innerHTML = "";

      const ref = db.ref(`extintores/${edificacao}`);
      ref.on("value", snapshot => {
        const dados = snapshot.val();
        container.innerHTML = "";

        if (!dados) {
          container.innerHTML = "<p>Nenhum extintor cadastrado.</p>";
          return;
        }

        Object.keys(dados).forEach(numero => {
          const ext = dados[numero];
          const btn = document.createElement("button");
          btn.id = `ext-${edificacao}-${numero}`;
          btn.innerText = ext.vistoriado ? `${numero} ✅ (${ext.por})` : numero;
          btn.className = ext.vistoriado ? "vistoriado" : "nao-vistoriado";
          btn.onclick = () => toggleExtintor(edificacao, numero);
          container.appendChild(btn);
        });
      });
    }

    // 🔹 Reset geral
    function resetarTodos() {
      if (confirm("Tem certeza que deseja resetar TODOS os extintores?")) {
        db.ref("extintores").once("value").then(snapshot => {
          const updates = {};
          snapshot.forEach(ed => {
            ed.forEach(ext => {
              updates[`extintores/${ed.key}/${ext.key}`] = { vistoriado: false, por: "" };
            });
          });
          db.ref().update(updates)
            .then(() => mostrarMensagem("🔄 Todos os extintores foram resetados!", "sucesso"))
            .catch(err => mostrarMensagem("❌ Erro ao resetar: " + err.message, "erro"));
        });
      }
    }

    // 🔹 Função seed organizada
    function seedExtintores() {
      const edificacoes = {
        "DESEMBARQUE": [1,2,3,4,5],
        "TPS TÉRREO": [6,7,8],
        "TPS SUPERIOR": [9,10,11],
        "ADM/RÁDIO": [12,13],
        "CASA DE BOMBAS": [14,15],
        "CAMPO DE ANTENAS": [16],
        "EMBARQUE": [17,18,19],
        "ELOS": [20,21],
        "APOC/PÁTIO AVIAÇÃO GERAL": [22,23,24],
        "PORTÃO 1": [25,26],
        "KF": [27],
        "PAA": [28,29],
        "MANUTENÇÃO": [30,31],
        "SCI": [32]
      };

      const updates = {};
      Object.keys(edificacoes).forEach(ed => {
        edificacoes[ed].forEach(num => {
          updates[`extintores/${ed}/${num}`] = { vistoriado: false, por: "" };
        });
      });

      db.ref().update(updates)
        .then(() => mostrarMensagem("✅ Extintores carregados com sucesso!", "sucesso"))
        .catch(err => mostrarMensagem("❌ Erro ao carregar extintores: " + err.message, "erro"));
    }

    // 🔹 Popular select com edificações
    const edificacoesArray = [
      "DESEMBARQUE", "TPS TÉRREO", "TPS SUPERIOR",
      "ADM/RÁDIO", "CASA DE BOMBAS", "CAMPO DE ANTENAS",
      "EMBARQUE", "ELOS", "APOC/PÁTIO AVIAÇÃO GERAL",
      "PORTÃO 1", "KF", "PAA", "MANUTENÇÃO", "SCI"
    ];

    const select = document.getElementById("edificacao");
    edificacoesArray.forEach(ed => {
      const opt = document.createElement("option");
      opt.value = ed;
      opt.text = ed;
      select.appendChild(opt);
    });

    select.addEventListener("change", e => renderizarExtintores(e.target.value));

    // 🔹 Renderizar a primeira edificação por padrão
    renderizarExtintores(edificacoesArray[0]);
  </script>
</body>
</html>
